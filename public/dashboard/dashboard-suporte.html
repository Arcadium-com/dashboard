<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../assets/css/padroes.css">
    <link rel="stylesheet" href="../assets/css/menu.css">
    <link rel="stylesheet" href="../assets/css/dashboard-suporte.css">
    <script src="https://kit.fontawesome.com/7ac0278b37.js" crossorigin="anonymous"></script>
</head>

<body onload="criarGraficoSuporte()">
    <nav class="MenuVertical">
        <p class="TituloMenu">MENU</p>
        <p id="Acesso">Nível</p>
        <ul class="ListaMenu">
            <li><a id="DashboardFuncionario" href="dashboard-funcionario.html">DashboardF</a></li>
            <li><a id="DashboardSuporte" class="PaginaAtual" href="dashboard-suporte.html">DashboardS</a></li>
            <li><a id="CadastroUsuarios" href="cadastro-funcionario.html">Usuários</a></li>
            <li><a target="_blank"
                    href="https://arcadium.atlassian.net/jira/servicedesk/projects/FK/queues/custom/1">Jira</a></li>
        </ul>
        <a href="../index.html"><span id="AzulBola"></span></a>
        <a href="../index.html"><span id="RoxoBola"></span></a>
    </nav>
    <main style="gap: 4em !important;" class="Dashboard">
        <span class="TituloBW">
            <img src="../../assets/imagens/icones/usuario.png" alt="">
            <h1>VISÃO GERAL DE SUPORTE TÉCNICO</h1>
        </span>
        <ul class="LegendaAlertas">
            <li style="background: var(--CriticoFundo);"><i class="fa-solid fa-bell" style="color: var(--Critico)"></i>
                <p>Crítico</p>
            </li>
            <li style="background: var(--RuimFundo);"><i class="fa-solid fa-bell" style="color: var(--Ruim)"></i>
                <p>Ruim</p>
            </li>
            <li style="background: var(--AlertaFundo);"><i class="fa-solid fa-bell" style="color: var(--Alerta)"></i>
                <p>Alerta</p>
            </li>
            <li style="background: var(--BomFundo);"><i class="fa-solid fa-bell" style="color: var(--Bom)"></i>
                <p>Bom</p>
            </li>
        </ul>
        <div class="selectBox">
            <select>
            </select>
            <button onclick="mudarMaquina()">Atualizar</button>
        </div>
        <div class="ContainerGraficos">
            <div class="cards HardwareGrafico">
                <p>Uso do disco atual</p>
                <canvas id="disco"></canvas>
            </div>
            <div class="cards HardwareGrafico">
                <p>Uso da RAM atual</p>
                <canvas id="memoria"></canvas>
            </div>
            <div class="cards HardwareGrafico">
                <p>Quantidade atual de USBs conectados</p>
                <canvas id="usb"></canvas>
            </div>
            <div class="cards HardwareGrafico">
                <p>Uso do processador atual</p>
                <canvas id="cpu"></canvas>
            </div>
            <div class="cards QtdHoras">
                <p>Quantidade total de alertas críticos do mês</p>
                <canvas id="alertasMes"></canvas>
            </div>
            <!-- <div class="cards StatusTotem">
                <canvas id="status-totem"></canvas>
            </div>
            <div class="cards HorariosUso">
                <canvas id="horarios-uso"></canvas>
            </div> -->
        </div>
    </main>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../assets/js/funcoes.js"></script>
<script src="../assets/js/service.js"></script>
<script>
    let permissao = sessionStorage.getItem("PERMISSAO")
    if (permissao != 1 && permissao != 2 && permissao != 4) window.location.href = "../index.html"
    function mudarMaquina() {
        sessionStorage.ID_MAQUINA = document.querySelector(".selectBox select").value
        location.reload();
    }
    puxarMaquinas();

    
    async function criarGraficoSuporte() {
        const disco = {
            html: document.getElementById("disco"),
            titulo: "Uso do disco",
            titulosEixos: { x: "Horário", y: "Percentual de uso" },
        };
        const memoria = {
            html: document.getElementById("memoria"),
            titulo: "Uso da memória",
            titulosEixos: { x: "Horário", y: "Percentual de uso" },
        };
        const usb = {
            html: document.getElementById("usb"),
            titulo: "Quantidade de entradas USB conectadas",
            titulosEixos: { x: "Horário", y: "Quantidade de USB conectados" },
        };
        const cpu = {
            html: document.getElementById("cpu"),
            titulo: "Uso do processador",
            titulosEixos: { x: "Horário", y: "Percentual de uso" },
        };
        const hardwares = [disco, memoria, usb, cpu];
        let listaGraficos = [];
        let dados = await puxarDadosMaquina();

        for (item of hardwares) {
            let tipoGrafico = item == usb ? "bar" : "line";
            let labels = dados.map((json) => json.hora);
            let registro;
            if (item == disco) registro = dados.map((json) => json.valorDisco);
            else if (item == memoria) registro = dados.map((json) => json.valorMemoriaRAM);
            else if (item == usb) registro = dados.map((json) => json["USB"]);
            else if (item == cpu) registro = dados.map((json) => json.valorCPU);
            let data = {
                labels: labels,
                datasets: [
                    {
                        label: item == usb ? "Quantidade de USBs conectados" : "Percentual de uso",
                        data: registro,
                    },
                ],
            };

            const grafico = new Chart(item.html, {
                type: tipoGrafico,
                data: data,
                options: {
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "Horários",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            max: item != usb ? 100 : null,
                            title: {
                                display: true,
                                text: item == usb ? "USBs conectadas" : "Percentual de uso"
                            },
                            ticks: {
                                stepSize: item == usb ? 1 : 10,
                            },
                        },
                    },
                },
            });

            listaGraficos.push(grafico); // Armazena a instância no array
        }
        setInterval(() => atualizar(listaGraficos), 999999999);
    }

    async function atualizar(listaGraficos){
        let contador = 1;
        //1o disco 2o memoria 3o usb 4o cpu
        for(grafico of listaGraficos){
            let novoDado = await puxarDadoMaisRecente();
            let novoLabel = novoDado[0].hora

            if(contador == 1) novoDado = novoDado[0].valorDisco;
            else if(contador == 2) novoDado = novoDado[0].valorMemoriaRAM;
            else if(contador == 3) novoDado = novoDado[0].USB;
            else if(contador == 4) novoDado = novoDado[0].valorCPU;

            let dataTamanho = grafico.data.datasets[0].data.length;
            //console.log("dado novo: " + novoDado)
            //console.log("ultimo dado antigo: " + grafico.data.datasets[0].data[dataTamanho - 1])
            
            if(grafico.data.datasets[0].data[dataTamanho - 1] != novoDado){
                grafico.data.datasets[0].data.push(novoDado);
                grafico.data.labels.push(novoLabel);
                verificarDados(novoDado, contador);
            }else{
                console.log("Sem dados novos...")
            }

            if(grafico.data.datasets[0].data.length > 7){
                grafico.data.datasets[0].data.shift()
                grafico.data.labels.shift()
            }
            
            grafico.update();

            contador++;
        }
    } 

    async function verificarDados(novoDado, contador){
        let alertaCritico = false;
        let indicadores = await puxarIndicadores();
        let hardware = []
       
        //1o disco 2o memoria 3o usb 4o cpu
        if(contador == 1){ 
            alertaCritico = novoDado < indicadores[0].limitedisco;
            hardware.push("Disco");
        }else if(contador == 2){ 
            alertaCritico = novoDado < indicadores[0].limiteram;
            hardware.push("RAM");
        }else if(contador == 3){ 
            alertaCritico = novoDado < indicadores[0].limiteusb;
            hardware.push("USB");
        }else if(contador == 4){ 
            alertaCritico = novoDado < indicadores[0].limitecpu;
            hardware.push("CPU");
        }

        if(alertaCritico){
            Swal.fire({
                title: `Alerta crítico relacionado aos componentes: ${hardware}`,
                icon: 'error',
                timer: 3000, // Tempo de exibição do toast em milissegundos
                toast: true,
                position: 'top-end',
                showConfirmButton: false
            })
        }
        
    }

    async function mostrarTotalAlertas(){
        let diasAlertas = await puxarDiasMesComQuantidadeAlertas();
        let elementoHTML = document.querySelector("#alertasMes")
        console.log(diasAlertas)

        const labels = diasAlertas.map(json => json.dia)
        const data = {
            labels: labels,
            datasets: [{
                label: "CPU",
                data: diasAlertas.map(json => json.qtd_alertas_cpu)
            },
            {
                label: "Disco",
                data: diasAlertas.map(json => json.qtd_alertas_disco)
            },
            {
                label: "USB",
                data: diasAlertas.map(json => json.qtd_alertas_usb)
            },
            {
                label: "RAM",
                data: diasAlertas.map(json => json.qtd_alertas_ram)
            }
        ]}

        new Chart(elementoHTML, {
                type: "line",
                data: data,
                options: {
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "Dias",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            max: item != usb ? 100 : null,
                            title: {
                                display: true,
                                text: "Quantidade de alertas no dia"
                            },
                            ticks: {
                                stepSize: item == usb ? 1 : 10,
                            },
                        },
                    },
                },
            });
    }

    mostrarTotalAlertas()

</script>